---
title: "Neutralise: an open source initiative for neutral comparison of two-sample tests"
output: github_document
---

# 1. Load required packages and Installation steps

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load required packages
library(ggplot2)
library(tfse)
library(zip)
library(tidyverse)
library(kSamples)
library(twosamples)
library(ggpubr)

```

## Github installation

Code to install *Neutralise*, with authentication code for permission. (Authentication code needs be deleted when the resporitory is set public)

```{r , message = FALSE}
library(devtools)

#install_github("lucp9827/Neutralise)

library(Neutralise)
```

## Initialise local directory structure

Download 'NeutraliseFiles.zip' from '<https://github.com/lucp9827/NeutraliseFiles>'. Unzip the 'NeutraliseFiles' file and save the path to this unzipped NeutraliseFiles folder.

```{r}
# Set working directory to (unzipped) NeutraliseFiles
path = ".\\NeutraliseFiles"
```

NeutraliseFiles contains 4 directories;

1.  **Data**: This Folder contains the available data generator functions.
2.  **Settings**: This Folder contains the settings for the existing data generators. If the settings have been simulated, the setting files change from an R-data file extension to an R workspace.
3.  **Issues**: This Folder contains text files with possible issues in the functionality and lay-out of the R-files (Data generator/Settings file/ Method file) for the Neutralise function. 
3.  **Methods**: This Folder contains the available statistical methods.
4.  **Results**: This folder contains the result of all combinations of statistical methods and simulation scenarios available, and a text file 'Finished' with information on the simulation runs already done, and an R-file describing the status of all methods, data generators and settings, and a Local folder for the results of the *single* operating mode.

# 2. Demonstration Neutralise

We will demonstrate two operating modes of Neutralise; **single** and **all**. First, we demonstrate the operating mode *single*, which allows a user to evaluate a single statistical method under a single simulation scenario. Second, we demonstrate the operating mode *all*, which allows the user to evaluate a new statistical method under all scenario's available on Github and compare the results to other statistical methods on Github. It's also possible to evaluate all statistical methods available on Github under a new simulation scenario.

## 2.1 Operating mode: *Single*

Suppose that you want to evaluate a method on a simulation scenario, but you are still in an "experimental stage" of your research and so you do not (yet) want to add your method or data generator method to the system. Then you can run the Neutralise in "single" mode. For example, we have a new method (here Anderson Darling).

```{r}
AD_Asymp<-function(db) {
  results<-kSamples::ad.test(db$y[db$group==1],db$y[db$group==2],
                   method="asymptotic")
  return(list(
    stat=results$ad[1,1],
    p.value=results$ad[1,3]
  ))
}
```

and we will use the following data generator

```{r}
ExpLocShift<-function(n1=10,n2=10,parameters=c(0,1)) {
  delta<-parameters[1]
  rate1<-parameters[2]
  y<-c(rexp(n1,rate = rate1),
       rexp(n2,rate = rate1)+delta)
  db<-data.frame(y=y, group=rep(c(1,2),c(n1,n2)))
  return(db)
}
```

and the following settings

```{r}
settings<-data.frame(
  delta=c(0,1,2,3),
  rate1=c(1,0.5,0.25,0.125),
  null=c(1,0,0,0)
)
```

Then we can run the following code. This will NOT add the new method and data generator to the *Methods* and *Data* directories, the results will be saved to the directory Results/Local so that the results are not mixed with the other results. However, the format in which the results are saved is the same as for the "all" mode. The power results are also in the object "res" so that the user does not necessarily has to go to the Results/Local directory.

```{r}
res<-Neutralise(path,Test=AD_Asymp,
                Data.Generator = ExpLocShift,
                settings=settings)
```

## 2.2 Operating mode: *All*

To run all combinations of statistical methods and simulation scenarios (i.e. combination of data generator and settings) available on Github the following code can be used and the results will be saved in the *Results* directory. This function can be used to reproduce results of previous simulations. Note: To reproduce results it's important to have (1) an 'empty' *Results* directory and (2) to reinitialise the files *Finished.txt* and *neutralise_status.Rfile*. Also (3) add the specific settings RData-files that you want to reproduce into the *Settings* directory.

```{r}

# Code to reinitilize the files *Finished.txt* and *neutralise_status.Rfile (dont run if you don't want to reproduce all results)

#Initialise_Neutralise(path)

# Run Neutralise main function 

res<-Neutralise(path)
```

Suppose that we now have some new additional settings to be run for a data generator that already exists. Then we add a new settings R-file to the directory *Settings* and run the neutralise function again. We'll first demonstrate how a new settings R-file should be constructed.

### Adding a new setting to the settings directory

Make sure the R-file for the new setting begins with the same name as the existing Data Generator R-file (in *Data* directory) for which the setting is developed and ends with '\_settings.R'.

```{r}

# Add setting for the 'Normal data generator' in the  Settings directory

settings<-data.frame(
  delta=c(0,0.5,1.5,2.5),
  sd=c(1,3,3,3),
  null=c(1,0,0,0)
)

# The setting will be saved in the Settings directory
save(settings,
       file=paste(path,"/Settings/Normal_settings.R",sep=""))

# Run the Neutralise main function

res<-Neutralise(path)
```

Suppose that we now have an new statistical method to be run for the data generators that already exists. Then we'll add a new method's R-file to the directory *Methods* and run the code again. We'll first demonstrate how a new method's R-file should be constructed, this 'code chunck' should be saved by the user as 'KS.R' in the *Methods* directory.

### Adding a new statistical test to the methods directory

Statistical tests can be added to the system as an R file with a single function. This function must be named **Test** and specify one argument **bd**, which is a data frame with two columns. One column must be named **y** and contains the *n\~1\~ + n\~2\~* sample observations, and the other column must be named **group** and contains values 1 and 2, referring to the groups the sample obserations come from. The R-file must contain a header that gives a **name** and a **description** of the method and references to the literature if appropriate. Also, add 1 empty line at the end of the R-file.

```{r}
# NAME
# Asymptotic Kolmogorov-Smirnov test
# DESCRIPTION
# Two sample Kolmogorov-Smirnov test . P-values based on asymptotic approximation
# REFERENCES
# Kolmogorov, A. 1933. Sulla Determinazione Empirica di una Legge di Distributione. Giornale dell'Istituto Italiano degli Attuari, 4: 1-11.
# Smirnov, H. 1939. Sur les Ecarts de la Courbe de Distribution Empirique. Recueil MathematiqueMatematiceskii Sbornik), : 3-26. N.S. 6
# END

Test<-function(db) {
    results<-ks.test(db$y[db$group==1],db$y[db$group==2],
                     alternative="two.sided")
    return(list(
      stat=results$statistic,
      p.value=results$p.value
    ))
}
```

After saving the new method in the *Methods* directory as an R-file, we can run the main neutralise function. The results of the new simulations can be found in the *Results* directory.

```{r}
res<-Neutralise(path)
```

## 3. Upload code or results to Github

This initiative is set up as an open science collaboration, and we hope that many users will make use of it and return the code and results to enhance this initiative. It just takes 5 steps! New users to github can find a quickstart guide of Github on the following website: <https://docs.github.com/en/get-started/quickstart/hello-world>

*Step 1*: Go to github.com/login and sign in

*Step 2*: Go to <https://github.com/lucp9827/NeutraliseFiles>

*Step 3*: Fork (copy) the repository 'NeutraliseFiles' to your own account. (<https://docs.github.com/en/get-started/quickstart/fork-a-repo>)

*Step 4*: Commit changes made to 'NeutraliseFiles' folders: Add new method, data generator or setting file to the correct directories. Commit (add) additional results as zip file.

*Step 5*: Create pull request to merge changes (commits) with the original NeutraliseFiles.

All the pull request will be checked by the coreteam and if validated they will be added to the repository.

## 4. Evaluate - report
## Report results - Type 1 error

```{r}

# All methods & data generation methods that have been 'neutralised'

methods = All_Neutralised(path)
data.gen = All_Neutralised(path, type='data')

method1=methods[2]

# Boxplot of type  error for a specified method - boxplot: over all data generators & scenarios - Every printed row is a specific setting scenario for a data generator. In the Results folder for the specified method(in combination with a data generator), you can find the specifics for all the scenario parameters

Graph1_type1error = Boxplot_TypeI(path,method1)
Graph1_type1error

# Boxplot of type 1 error for a specified method per data generation method

Graph2_type1error = Boxplot_TypeI(path,method1,panel="distribution")
Graph2_type1error


# Boxplot of type error for a specified method per sample size (total sample size)

Graph3_type1error = Boxplot_TypeI(path,method1,panel="n")
Graph3_type1error



```

## Report results - Power

### Power-Power plot
```{r}
#load(paste(path,'\\Results\\NeutraliseStatus.RData',sep=''))

library(dplyr)

# All methods & data generation methods that have been 'neutralised'

methods = All_Neutralised(path)
data.gen = All_Neutralised(path, type='data')

method1=methods[2] # CVM
method2=methods[5] # "TTest_VarUnequal"

# Power-power Plot - all data generation methods 

Graph1 = Power_QQ(path,method1,method2,alpha=0.05)

Graph1$graph

# Power-power Plot - specified Data Generator = Logistic

Graph1b = Power_QQ(path,method1,method2,alpha=0.05,data='Logistic')

Graph1b$graph


# Power-power Plot - per data generation method 
Graph2 = Power_QQ(path,methods[2],methods[5],alpha=0.01,group=TRUE)

Graph2$graph


# Power-power Plot- per data generation method and a specified setting parameter (delta = 0.5 --> difference in means of 0.5)

db=data.frame(delta=0.5) # important that the specified parameter is exactly the same as in the setting file 

Graph3 = Power_QQ(path,methods[2],methods[5],alpha=0.05,group=TRUE,par.fix=db)

Graph3$graph

```
### Power-curve 
```{r}

```

